var $attach_name=1,add_attachment_fileinput=function(){var e=arguments;if(e.length>0&&e[0]=="delete")var t=max_attachs+1;else var t=max_attachs;var n=$("#attachment ul");if(n.children("li.clearfix").length<t){var r=n.children("li.hidden").clone(!0);r.removeClass("hidden").addClass("clearfix"),n.append(r);var i=n.find("li:last-child");i.hide(),i.slideDown(200),$attach_name++,i.find("input:file").attr("name","attach[{0}]".format($attach_name)),n.next("span").remove()}else n.next().length==0&&n.after('<span style="color:red; line-height:25px;">每次最多添加{0}个附件，现在已经添加{0}个，不能再添加了</span>'.format(max_attachs))};$(document).ready(function(){$(".pagination a").each(function(){var e=$(this);e.attr("href",e.attr("href")+"#comments")}),$(".field_with_errors:has(#article_content)").css({width:"100%"}),$("span#add_attach_span a").click(function(){var e=$(this);e.hide(),$("#attachment").show()}),$("#attachment li input:file").change(function(e){var t=$(this);try{var n=e.target.files,r=n[0],i=r.name;if(r.size>max_upfile_size)return alert("文件大小超过限制"),t.val(""),!1}catch(s){var i=t.val().split(/(\\|\/)/).last()}if(t.next().hasClass("max")){var o=$("#attachment span.hidden:first-child").clone(!0),u=$("#attachment span.hidden:nth-child(2)").clone(!0);o.removeClass("hidden").addClass("opt"),u.removeClass("hidden").addClass("filename"),t.next().remove(),t.after(u),t.next().html('<font color="#000000">[附件{0}]</font>{1}'.format($attach_name,i)).after(o),t.next().height()>30&&t.next().css({height:"25px","line-height":"12px"}),t.parentsUntil("ul").css({"border-bottom":"1px dotted #AAA"}),add_attachment_fileinput()}else t.next().html('<font color="#000000">[附件{0}]</font>{1}'.format(t.attr("name").match(/attach\[(\d+)\]/)[1],i))}),$('#attachment a[href^="###"]').click(function(){var $this=$(this),$str=$this.parentsUntil("ul").children("input:file, input:text").attr("name").match(/attach\[(\d+)\]/)[1];$str="[附件{0}]".format($str);if($this.html()=="删除"){var $ul=$this.parentsUntil("ul").parent();$ul.find("li.clearfix span.max").length==0&&add_attachment_fileinput("delete"),content_type==0?editor.html(editor.html().replace(eval("/"+$str.replace("[","\\[").replace("]","\\]")+"/g"),"")):$("#article_content").val($("#article_content").val().replace(eval("/"+$str.replace("[","\\[").replace("]","\\]")+"/g"),"")),$this.parentsUntil("ul").slideUp(200,function(){$(this).remove()})}else $this.parent().parent().attr("class")=="clearfix"&&(content_type==0?editor.insertHtml($str):($("#article_content").setCaret(),$("#article_content").insertAtCaret($str)))}),$('.comment .comment_main .head a:contains("删除")').each(function(){var e=$(this);e.hide(),e.parent().parent().parent().hover(function(){e.show()},function(){e.hide()})})}),jQuery.fn.extend({setCaret:function(){if(/msie/.test(navigator.userAgent.toLowerCase())==0)return;var e=function(){var e=$(this).get(0);e.caretPos=document.selection.createRange().duplicate()};$(this).click(e).select(e).keyup(e)},insertAtCaret:function(e){var t=$(this).get(0);if(document.all&&t.createTextRange&&t.caretPos){var n=t.caretPos;n.text=n.text.charAt(n.text.length-1)==""?e+"":e,n.select()}else if(t.setSelectionRange){var r=t.selectionStart,i=t.selectionEnd,s=t.value.substring(0,r),o=t.value.substring(i);if((s.split("[").last()+o.split("]").first()).match(/^附件\d+$/i)){var u=o.split("]").first().length+1;r+=u,s=t.value.substring(0,r),o=t.value.substring(i+u)}t.value=s+e+o,t.focus();var a=e.length;t.setSelectionRange(r+a,r+a)}else t.value+=e}});